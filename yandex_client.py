"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å YandexGPT —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Yandex AI Studio SDK.
–ü–∞–∫–µ—Ç: yandex-ai-studio-sdk (pip install yandex-ai-studio-sdk)
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://yandex.cloud/ru/docs/ai-studio
GitHub SDK: https://github.com/yandex-cloud/yandex-ai-studio-sdk
"""
import hashlib
import logging
import asyncio
from datetime import datetime, timedelta
from collections import OrderedDict

from yandex_ai_studio_sdk import AIStudio

from config import (
    YANDEX_FOLDER_ID,
    YANDEX_API_KEY,
    YANDEX_MODEL,
    YANDEX_TEMPERATURE,
    YANDEX_MAX_TOKENS,
    CACHE_MAX_SIZE,
    CACHE_TTL_HOURS,
)

logger = logging.getLogger(__name__)

# ======================================================
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SDK
# ======================================================
# AIStudio –ø—Ä–∏–Ω–∏–º–∞–µ—Ç auth= –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∫ API-–∫–ª—é—á –∏–ª–∏ IAM-—Ç–æ–∫–µ–Ω ‚Äî
# SDK –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–æ —Ñ–æ—Ä–º–∞—Ç—É —Å—Ç—Ä–æ–∫–∏.
sdk = AIStudio(
    folder_id=YANDEX_FOLDER_ID,
    auth=YANDEX_API_KEY,
)

# –°–æ–∑–¥–∞—ë–º —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑ (reuse)
# sdk.models.completions() ‚Äî –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ chat/completion
# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏: "yandexgpt", "yandexgpt-lite", "yandexgpt-32k"
_sync_model = (
    sdk.models.completions(YANDEX_MODEL)
    .configure(
        temperature=YANDEX_TEMPERATURE,
        max_tokens=YANDEX_MAX_TOKENS,
    )
)

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ç–æ–π –∂–µ –º–æ–¥–µ–ª–∏ (SDK –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ä–µ–∂–∏–º–∞)
_async_model = (
    sdk.async_client.models.completions(YANDEX_MODEL)
    .configure(
        temperature=YANDEX_TEMPERATURE,
        max_tokens=YANDEX_MAX_TOKENS,
    )
    if hasattr(sdk, "async_client")
    else None
)

# ======================================================
# LRU-–ö–≠–® (—ç–∫–æ–Ω–æ–º–∏–º –∑–∞–ø—Ä–æ—Å—ã –∫ API)
# ======================================================
_cache: OrderedDict = OrderedDict()


def _cache_key(prompt: str) -> str:
    """MD5-—Ö—ç—à –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–∫ –∫–ª—é—á –∫—ç—à–∞."""
    return hashlib.md5(prompt.lower().strip().encode("utf-8")).hexdigest()


def _from_cache(key: str) -> str | None:
    """–í–µ—Ä–Ω—É—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –æ–Ω –Ω–µ —É—Å—Ç–∞—Ä–µ–ª."""
    if key not in _cache:
        return None
    text, created_at = _cache[key]
    if datetime.now() - created_at > timedelta(hours=CACHE_TTL_HOURS):
        del _cache[key]
        return None
    _cache.move_to_end(key)   # LRU ‚Äî –¥–≤–∏–≥–∞–µ–º –∫ ¬´–≥–æ—Ä—è—á–µ–º—É¬ª –∫–æ–Ω—Ü—É
    return text


def _to_cache(key: str, text: str) -> None:
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à, –≤—ã—Ç–µ—Å–Ω–∏–≤ —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏."""
    _cache[key] = (text, datetime.now())
    _cache.move_to_end(key)
    if len(_cache) > CACHE_MAX_SIZE:
        _cache.popitem(last=False)   # —É–¥–∞–ª—è–µ–º —Å–∞–º—ã–π ¬´—Ö–æ–ª–æ–¥–Ω—ã–π¬ª


# ======================================================
# –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢
# ======================================================
SYSTEM_PROMPT = """–¢—ã ‚Äî AI-–®–µ—Ñ, —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –í–û–°–•–ò–¢–ò–¢–ï–õ–¨–ù–´–ï, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü–†–ê–í–ò–õ–ê:
1. –†–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–º—ã–º –¥–æ–º–∞ –∑–∞ —Ä–∞–∑—É–º–Ω–æ–µ –≤—Ä–µ–º—è
2. –ü—Ä–µ–¥–ª–∞–≥–∞–π –∑–∞–º–µ–Ω—ã –¥–ª—è —Ä–µ–¥–∫–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–µ—Å–ª–∏ –Ω–µ—Ç X, –∑–∞–º–µ–Ω–∏ –Ω–∞ Y¬ª)
3. –î–æ–±–∞–≤–ª—è–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ, –≤–∫—É—Å–Ω—ã–µ –∏–¥–µ–∏ ‚Äî —É–¥–∏–≤–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!
4. –£—á–∏—Ç—ã–≤–∞–π —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
5. –î–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã –ø–æ –ø–æ–¥–∞—á–µ –∏ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–µ

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π):

üç≥ [–ö–†–ï–ê–¢–ò–í–ù–û–ï –ù–ê–ó–í–ê–ù–ò–ï –ë–õ–Æ–î–ê ‚Äî –Ω–µ –±–∞–Ω–∞–ª—å–Ω–æ–µ!]

üìã –ò–ù–ì–†–ï–î–ò–ï–ù–¢–´:
- [–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç] ‚Äî [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]
(–µ—Å–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å, –¥–æ–±–∞–≤—å –≤ —Å–∫–æ–±–∫–∞—Ö: –∏–ª–∏ [–∑–∞–º–µ–Ω–∞])

üë®‚Äçüç≥ –ü–†–ò–ì–û–¢–û–í–õ–ï–ù–ò–ï:
1. [—á—ë—Ç–∫–∏–π —à–∞–≥ —Å –¥–µ—Ç–∞–ª—è–º–∏]
2. [—Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥]
(–Ω–µ –º–µ–Ω–µ–µ 4 —à–∞–≥–æ–≤, –Ω–µ –±–æ–ª–µ–µ 8)

üí° –°–û–í–ï–¢ –®–ï–§–ê:
[1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å–µ–∫—Ä–µ—Ç–æ–º –∏–ª–∏ –∏–¥–µ–µ–π –¥–ª—è –ø–æ–¥–∞—á–∏]

‚è± –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: [X –º–∏–Ω—É—Ç/—á–∞—Å–æ–≤]
üå° –°–ª–æ–∂–Ω–æ—Å—Ç—å: [–õ–µ–≥–∫–æ / –°—Ä–µ–¥–Ω–µ / –°–ª–æ–∂–Ω–æ]
ü•ó –ü–æ—Ä—Ü–∏–π: [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º!"""


def _build_user_prompt(user_input: str) -> str:
    """–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç."""
    return (
        f'–°–æ–∑–¥–∞–π —Ä–µ—Ü–µ–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:\n\n"{user_input}"\n\n'
        "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –∫–∞–∫ –æ—Å–Ω–æ–≤—É.\n"
        "–ï—Å–ª–∏ –æ–ø–∏—Å–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—é ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –±–ª—é–¥–æ.\n"
        "–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ–ø–æ–ª–Ω—ã–π ‚Äî –ø—Ä–æ—è–≤–∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ —Å–æ–∑–¥–∞–π —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ!"
    )


# ======================================================
# –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò
# ======================================================

async def generate_recipe(user_input: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ—Ü–µ–ø—Ç —á–µ—Ä–µ–∑ YandexGPT (Yandex AI Studio).

    –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç—ã:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç LRU-–∫—ç—à ‚Äî —ç–∫–æ–Ω–æ–º–∏–º –∑–∞–ø—Ä–æ—Å—ã –∫ API
    2. –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (system + user)
    3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ YandexGPT —á–µ—Ä–µ–∑ SDK (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –≤ executor,
       —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π event loop Telegram-–±–æ—Ç–∞)
    4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—ç—à –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Ä–µ—Ü–µ–ø—Ç–∞

    Args:
        user_input: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –±–ª—é–¥–æ)

    Returns:
        –°—Ç—Ä–æ–∫–∞ —Å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ä–µ—Ü–µ–ø—Ç–æ–º

    Raises:
        RuntimeError: –µ—Å–ª–∏ YandexGPT –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
    """
    key = _cache_key(user_input)

    # –®–∞–≥ 1: –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –∫—ç—à–∞
    cached = _from_cache(key)
    if cached:
        logger.info(f"üì¶ –†–µ—Ü–µ–ø—Ç –∏–∑ –∫—ç—à–∞: '{user_input[:40]}...'")
        return cached + "\n\n_üí® –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –∫—ç—à–∞_"

    # –®–∞–≥ 2: —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ SDK
    # SDK –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ø–∏—Å–æ–∫ dict {"role": ..., "text": ...}
    messages = [
        {"role": "system", "text": SYSTEM_PROMPT},
        {"role": "user",   "text": _build_user_prompt(user_input)},
    ]

    try:
        logger.info(f"ü§ñ –ó–∞–ø—Ä–æ—Å –∫ YandexGPT [{YANDEX_MODEL}]: '{user_input[:40]}...'")

        # –®–∞–≥ 3: SDK —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ,
        # —á—Ç–æ–±—ã –Ω–µ –∑–∞–º–æ—Ä–æ–∑–∏—Ç—å event loop –±–æ—Ç–∞ –Ω–∞ –≤—Ä–µ–º—è HTTP-–∑–∞–ø—Ä–æ—Å–∞.
        loop = asyncio.get_running_loop()
        result = await loop.run_in_executor(
            None,                          # –∏—Å–ø–æ–ª—å–∑—É–µ–º ThreadPoolExecutor –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            lambda: _sync_model.run(messages)   # —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ YandexGPT
        )

        # result ‚Äî –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º alternatives (—Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞)
        if not result.alternatives or not result.alternatives[0].text:
            raise RuntimeError("YandexGPT –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")

        recipe_text = result.alternatives[0].text.strip()

        # –®–∞–≥ 4: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        _to_cache(key, recipe_text)

        logger.info("‚úÖ –†–µ—Ü–µ–ø—Ç –æ—Ç YandexGPT –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        return recipe_text

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ YandexGPT: {e}", exc_info=True)
        raise RuntimeError(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç: {e}") from e
